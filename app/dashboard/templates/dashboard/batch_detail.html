{% extends "base.html" %}

{% block title %}Batch Detail | PDF Processing API{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Batch Detail</h1>
        <a href="/dashboard/batches" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Batches
        </a>
    </div>
    
    <!-- Batch Overview Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                Batch Information
                {% if batch.request_data and batch.request_data.source == "single_pdf_processing" %}
                <span class="badge bg-primary ms-2">Single PDF Processing</span>
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th>Batch ID:</th>
                            <td>{{ batch.batch_id }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                <span class="badge bg-{{ 'warning' if batch.status == 'pending' else 'info' if batch.status == 'processing' else 'success' if batch.status == 'completed' else 'danger' }}">
                                    {{ batch.status }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td>{{ batch.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <th>Completed:</th>
                            <td>
                                {% if batch.completed_at %}
                                    {{ batch.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th>Total Files:</th>
                            <td>{{ batch.total_files }}</td>
                        </tr>
                        <tr>
                            <th>Processed Files:</th>
                            <td>{{ batch.processed_files }}</td>
                        </tr>
                        <tr>
                            <th>Failed Files:</th>
                            <td>{{ batch.failed_files }}</td>
                        </tr>
                        <tr>
                            <th>Processing Time:</th>
                            <td>
                                {% if batch.completed_at %}
                                    {{ ((batch.completed_at - batch.created_at).total_seconds() / 60)|round(2) }} minutes
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% if batch.request_data and batch.request_data.source == "single_pdf_processing" and batch.request_data.file %}
                        <tr>
                            <th>Source:</th>
                            <td>Process PDF page</td>
                        </tr>
                        <tr>
                            <th>PDF URL:</th>
                            <td>
                                <a href="{{ batch.request_data.file }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;">
                                    {{ batch.request_data.file }}
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Request Data -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Request Data</h5>
        </div>
        <div class="card-body">
            <div class="position-relative">
                <button class="btn btn-sm btn-outline-secondary copy-btn" data-target="#requestData">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <pre class="json" id="requestData">{{ batch.request_data|tojson(indent=2) }}</pre>
            </div>
        </div>
    </div>
    
    <!-- Files -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Processing Results</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Request ID</th>
                            <th>File Name</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Completed</th>
                            <th>Processing Time</th>
                            <th>AI Results</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr>
                            <td>
                                <small class="text-muted">{{ job.job_id[:8] }}...</small>
                            </td>
                            <td>
                                <a href="{{ job.file_url }}" target="_blank" class="text-decoration-none">
                                    {{ job.file_name }}
                                    <i class="fas fa-external-link-alt ms-1 small"></i>
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'warning' if job.status == 'processing' else 'success' if job.status == 'completed' else 'warning' if job.status == 'partial_failure' else 'danger' }}">
                                    {{ job.status.replace('_', ' ').title() }}
                                </span>
                                {% if job.error_results %}
                                <i class="fas fa-exclamation-triangle text-warning ms-1" title="Has errors"></i>
                                {% endif %}
                            </td>
                            <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if job.completed_at %}
                                    {{ job.completed_at.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if job.processing_time %}
                                    {{ (job.processing_time / 1000)|round(2) }} seconds
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    {% if job.metadata_result %}
                                    <span class="badge bg-{{ 'success' if job.metadata_result.status == 'completed' else 'danger' }}" title="Metadata">
                                        M
                                    </span>
                                    {% endif %}
                                    {% if job.references_result %}
                                    <span class="badge bg-{{ 'success' if job.references_result.status == 'completed' else 'danger' }}" title="References">
                                        R
                                    </span>
                                    {% endif %}
                                    {% if job.error_results %}
                                    <span class="badge bg-danger" title="Errors">
                                        E
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewJobDetails('{{ job.job_id }}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- AI Processing Results Details (Expandable) -->
    {% for job in jobs %}
    <div class="card mb-4" id="job-details-{{ job.job_id }}" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">
                Processing Details: {{ job.file_name }}
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="hideJobDetails('{{ job.job_id }}')">
                    <i class="fas fa-times"></i> Close
                </button>
            </h5>
        </div>
        <div class="card-body">
            <!-- Processing Request Info -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Request ID:</strong> {{ job.job_id }}<br>
                    <strong>Request Type:</strong> {{ job.processing_request.request_type }}<br>
                    <strong>Operations:</strong> 
                    <code>{{ job.processing_request.requested_operations|tojson }}</code>
                </div>
                <div class="col-md-6">
                    <strong>Document ID:</strong> {{ job.document.id }}<br>
                    <strong>File URL:</strong> 
                    <a href="{{ job.document.file_url }}" target="_blank">{{ job.document.file_url }}</a>
                </div>
            </div>

            <!-- AI Results Tabs -->
            <ul class="nav nav-tabs" id="aiResultTabs-{{ job.job_id }}" role="tablist">
                {% if job.metadata_result %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="metadata-tab-{{ job.job_id }}" data-bs-toggle="tab" 
                            data-bs-target="#metadata-{{ job.job_id }}" type="button" role="tab">
                        Metadata 
                        <span class="badge bg-{{ 'success' if job.metadata_result.status == 'completed' else 'danger' }} ms-1">
                            {{ job.metadata_result.status }}
                        </span>
                    </button>
                </li>
                {% endif %}
                {% if job.references_result %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {{ 'active' if not job.metadata_result else '' }}" 
                            id="references-tab-{{ job.job_id }}" data-bs-toggle="tab" 
                            data-bs-target="#references-{{ job.job_id }}" type="button" role="tab">
                        References
                        <span class="badge bg-{{ 'success' if job.references_result.status == 'completed' else 'danger' }} ms-1">
                            {{ job.references_result.status }}
                        </span>
                    </button>
                </li>
                {% endif %}
                {% if job.error_results %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {{ 'active' if not job.metadata_result and not job.references_result else '' }}" 
                            id="errors-tab-{{ job.job_id }}" data-bs-toggle="tab" 
                            data-bs-target="#errors-{{ job.job_id }}" type="button" role="tab">
                        Errors
                        <span class="badge bg-danger ms-1">{{ job.error_results|length }}</span>
                    </button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content" id="aiResultTabContent-{{ job.job_id }}">
                <!-- Metadata Tab -->
                {% if job.metadata_result %}
                <div class="tab-pane fade show active" id="metadata-{{ job.job_id }}" role="tabpanel">
                    <div class="mt-3">
                        <h6>Processed Result</h6>
                        <div class="position-relative">
                            <button class="btn btn-sm btn-outline-secondary copy-btn" data-target="#metadata-processed-{{ job.job_id }}">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <pre class="json" id="metadata-processed-{{ job.job_id }}">{{ job.metadata_result.processed_result|tojson(indent=2) }}</pre>
                        </div>
                        
                        <h6 class="mt-4">Raw AI Response</h6>
                        <div class="position-relative">
                            <button class="btn btn-sm btn-outline-secondary copy-btn" data-target="#metadata-raw-{{ job.job_id }}">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <pre class="json" id="metadata-raw-{{ job.job_id }}">{{ job.metadata_result.raw_ai_response|tojson(indent=2) }}</pre>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- References Tab -->
                {% if job.references_result %}
                <div class="tab-pane fade {{ 'show active' if not job.metadata_result else '' }}" 
                     id="references-{{ job.job_id }}" role="tabpanel">
                    <div class="mt-3">
                        <h6>Processed Result ({{ job.references_result.processed_result|length if job.references_result.processed_result is iterable else 0 }} references)</h6>
                        <div class="position-relative">
                            <button class="btn btn-sm btn-outline-secondary copy-btn" data-target="#references-processed-{{ job.job_id }}">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <pre class="json" id="references-processed-{{ job.job_id }}">{{ job.references_result.processed_result|tojson(indent=2) }}</pre>
                        </div>
                        
                        <h6 class="mt-4">Raw AI Response</h6>
                        <div class="position-relative">
                            <button class="btn btn-sm btn-outline-secondary copy-btn" data-target="#references-raw-{{ job.job_id }}">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <pre class="json" id="references-raw-{{ job.job_id }}">{{ job.references_result.raw_ai_response|tojson(indent=2) }}</pre>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Errors Tab -->
                {% if job.error_results %}
                <div class="tab-pane fade {{ 'show active' if not job.metadata_result and not job.references_result else '' }}" 
                     id="errors-{{ job.job_id }}" role="tabpanel">
                    <div class="mt-3">
                        {% for error in job.error_results %}
                        <div class="alert alert-danger">
                            <h6>Error #{{ loop.index }}</h6>
                            <strong>Type:</strong> {{ error.error_type }}<br>
                            <strong>Step:</strong> {{ error.error_step }}<br>
                            <strong>Message:</strong> {{ error.error_message }}<br>
                            <strong>Time:</strong> {{ error.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Webhook Response -->
    {% if batch.webhook_response %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Webhook Response</h5>
        </div>
        <div class="card-body">
            <div class="position-relative">
                <button class="btn btn-sm btn-outline-secondary copy-btn" data-target="#webhookResponse">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <pre class="json" id="webhookResponse">{{ batch.webhook_response|tojson(indent=2) }}</pre>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function viewJobDetails(jobId) {
    document.getElementById('job-details-' + jobId).style.display = 'block';
    // Scroll to the details
    document.getElementById('job-details-' + jobId).scrollIntoView({ behavior: 'smooth' });
}

function hideJobDetails(jobId) {
    document.getElementById('job-details-' + jobId).style.display = 'none';
}

// Copy functionality
document.addEventListener('DOMContentLoaded', function() {
    const copyButtons = document.querySelectorAll('.copy-btn');
    
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                // Create a temporary textarea to copy the text
                const textarea = document.createElement('textarea');
                textarea.value = targetElement.textContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                // Show feedback
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i> Copied';
                this.classList.add('btn-success');
                this.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-secondary');
                }, 2000);
            }
        });
    });
});
</script>
{% endblock %}
